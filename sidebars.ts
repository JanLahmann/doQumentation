import type {SidebarsConfig} from '@docusaurus/plugin-content-docs';
import type {SidebarItemConfig} from '@docusaurus/plugin-content-docs/lib/sidebars/types';

// Docusaurus i18n generates translation keys from category labels. When multiple
// sidebar sections (tutorials, guides) share category names like "Get started" or
// "Qiskit Functions", the keys collide and the build fails. This collects all
// category labels from one section, then renames collisions in another section.
function collectCategoryLabels(items: SidebarItemConfig[], labels: Set<string> = new Set()): Set<string> {
  for (const item of items) {
    if (typeof item === 'object' && 'type' in item && item.type === 'category') {
      const cat = item as {label: string; items?: SidebarItemConfig[]};
      labels.add(cat.label);
      if (cat.items) collectCategoryLabels(cat.items, labels);
    }
  }
  return labels;
}

function deduplicateLabels(items: SidebarItemConfig[], existing: Set<string>, suffix: string): SidebarItemConfig[] {
  return items.map((item) => {
    if (typeof item === 'object' && 'type' in item && item.type === 'category') {
      const cat = item as {type: 'category'; label: string; items: SidebarItemConfig[]; [k: string]: unknown};
      const dedupedItems = cat.items ? deduplicateLabels(cat.items, existing, suffix) : [];
      if (existing.has(cat.label)) {
        return {...cat, label: `${cat.label} (${suffix})`, items: dedupedItems};
      }
      return {...cat, items: dedupedItems};
    }
    return item;
  });
}

// Import generated sidebar structures from sync-content.py
// Falls back to autogenerated/empty if sync hasn't run yet
let tutorialItems: SidebarItemConfig[];
try {
  tutorialItems = require('./sidebar-generated.json');
} catch {
  tutorialItems = [{type: 'autogenerated', dirName: 'tutorials'}];
}

let guideItems: SidebarItemConfig[];
try {
  guideItems = require('./sidebar-guides.json');
} catch {
  guideItems = [];
}

let courseItems: SidebarItemConfig[];
try {
  courseItems = require('./sidebar-courses.json');
} catch {
  courseItems = [];
}

let moduleItems: SidebarItemConfig[];
try {
  moduleItems = require('./sidebar-modules.json');
} catch {
  moduleItems = [];
}

// Collect tutorial category labels so we can rename collisions in guides
const tutorialLabels = collectCategoryLabels(tutorialItems);

const sidebars: SidebarsConfig = {
  tutorialsSidebar: [
    {
      type: 'category',
      label: 'Tutorials',
      collapsed: true,
      link: {type: 'doc', id: 'tutorials/index'},
      items: tutorialItems,
    },
    ...(guideItems.length > 0
      ? [
          {
            type: 'category' as const,
            label: 'Guides',
            collapsed: true,
            link: {type: 'doc' as const, id: 'guides/index'},
            items: deduplicateLabels(guideItems, tutorialLabels, 'Guides'),
          },
        ]
      : []),
    ...(courseItems.length > 0
      ? [
          {
            type: 'category' as const,
            label: 'Courses',
            collapsed: true,
            items: courseItems,
          },
        ]
      : []),
    ...(moduleItems.length > 0
      ? [
          {
            type: 'category' as const,
            label: 'Modules',
            collapsed: true,
            items: moduleItems,
          },
        ]
      : []),
    /* API Reference + Settings are in the navbar â€” not duplicated here */
  ],
};

export default sidebars;
