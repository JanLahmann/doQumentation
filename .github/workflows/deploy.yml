name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Sync upstream content
        run: python3 scripts/sync-content.py

      - name: Install dependencies
        run: npm ci

      - name: Build site (English only)
        run: npx docusaurus build --locale en
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'

      - name: Push notebooks to notebooks branch
        run: |
          TOKEN_URL="https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"

          # Clone existing notebooks branch (preserves locale subdirs from deploy-locales)
          git clone --depth 1 --branch notebooks "$TOKEN_URL" notebooks-repo 2>/dev/null || {
            mkdir notebooks-repo && cd notebooks-repo && git init && git checkout -b notebooks && cd ..
          }
          cd notebooks-repo

          # Remove EN content only (keep locale subdirs like de/, es/, etc.)
          for d in tutorials guides learning docs; do rm -rf "$d" 2>/dev/null; done

          # Copy fresh EN notebooks from build output
          cp -r ../build/notebooks/* .

          # Binder config â€” core packages in requirements.txt (cached layer),
          # lighter packages + cleanup in postBuild (smaller layer)
          mkdir -p binder
          cat > binder/requirements.txt << 'REQS'
          qiskit[visualization]~=2.3.0
          qiskit-aer~=0.17
          qiskit-ibm-runtime~=0.43.1
          REQS
          cat > binder/postBuild << 'POST'
          #!/bin/bash
          set -e
          pip install --no-cache-dir --no-compile --quiet \
            qiskit-ibm-catalog \
            qiskit-ibm-transpiler \
            qiskit-addon-cutting \
            pylatexenc \
            scikit-learn \
            networkx
          # Cleanup in same layer to actually reduce size
          find ${NB_PYTHON_PREFIX}/lib -type d -name tests -exec rm -rf {} + 2>/dev/null || true
          find ${NB_PYTHON_PREFIX}/lib -type d -name test -exec rm -rf {} + 2>/dev/null || true
          find ${NB_PYTHON_PREFIX}/lib -name '*.pyc' -delete 2>/dev/null || true
          find ${NB_PYTHON_PREFIX}/lib -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
          find ${NB_PYTHON_PREFIX}/lib -name '*.so' -exec strip --strip-unneeded {} + 2>/dev/null || true
          rm -rf ${NB_PYTHON_PREFIX}/share/{doc,man,gtk-doc} 2>/dev/null || true
          POST
          chmod +x binder/postBuild
          echo "python-3.12" > binder/runtime.txt

          git add -A
          git diff --cached --quiet && echo "No notebook changes" && exit 0
          git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" \
            commit -m "Update EN notebooks + Binder config from ${{ github.sha }}"
          git push --force "$TOKEN_URL" notebooks

      - uses: actions/upload-pages-artifact@v3
        with:
          path: build

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
