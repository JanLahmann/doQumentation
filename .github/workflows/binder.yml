name: Binder Cache

on:
  schedule:
    - cron: "0 6 * * *"
  # push:
  #   branches: [notebooks]    # Re-enable after verifying Binder builds successfully
  workflow_dispatch:

jobs:
  warm:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        binder:
          - name: 2i2c
            url: https://2i2c.mybinder.org/build/gh/JanLahmann/doQumentation/notebooks
          - name: BIDS
            url: https://bids.mybinder.org/build/gh/JanLahmann/doQumentation/notebooks
          - name: GESIS
            url: https://notebooks.gesis.org/binder/build/gh/JanLahmann/doQumentation/notebooks
    name: Warm ${{ matrix.binder.name }}
    steps:
      - name: Trigger Binder build on ${{ matrix.binder.name }}
        run: |
          curl -s --max-time 1200 \
            "${{ matrix.binder.url }}" \
          | while IFS= read -r line; do
              echo "$line"
              if echo "$line" | grep -q '"phase": "ready"'; then
                echo "Binder image is ready on ${{ matrix.binder.name }}."
                exit 0
              fi
              if echo "$line" | grep -q '"phase": "failed"'; then
                echo "::error::Binder build failed on ${{ matrix.binder.name }}."
                exit 1
              fi
            done
